var gdjs;(function(s){const n=GlobalPIXIModule.PIXI;class l{constructor(e,i){this._filters={};this._renderTexture=null;this._lightingSprite=null;this._oldWidth=null;this._oldHeight=null;this._pixiContainer=new n.Container,this._layer=e,this._runtimeSceneRenderer=i,this._pixiRenderer=i.getPIXIRenderer(),this._isLightingLayer=e.isLightingLayer(),this._clearColor=e.getClearColor(),i.getPIXIContainer().addChild(this._pixiContainer),this._pixiContainer.filters=[],this._isLightingLayer&&this._replaceContainerWithSprite()}getRendererObject(){return this._pixiContainer}getLightingSprite(){return this._lightingSprite}updatePosition(){const e=-s.toRad(this._layer.getCameraRotation()),i=this._layer.getCameraZoom();this._pixiContainer.rotation=e,this._pixiContainer.scale.x=i,this._pixiContainer.scale.y=i;const t=Math.cos(e),r=Math.sin(e),o=this._layer.getCameraX()*i*t-this._layer.getCameraY()*i*r,a=this._layer.getCameraX()*i*r+this._layer.getCameraY()*i*t;this._pixiContainer.position.x=-o,this._pixiContainer.position.y=-a,this._pixiContainer.position.x+=this._layer.getWidth()/2,this._pixiContainer.position.y+=this._layer.getHeight()/2}updateVisibility(e){this._pixiContainer.visible=!!e}update(){this._renderTexture&&this._updateRenderTexture();for(const e in this._filters){const i=this._filters[e];i.update(i.pixiFilter,this._layer)}}addEffect(e){const i=s.PixiFiltersTools.getFilterCreator(e.effectType);if(!i){console.log('Filter "'+e.name+'" has an unknown effect type: "'+e.effectType+'". Was it registered properly? Is the effect type correct?');return}const t={pixiFilter:i.makePIXIFilter(this._layer,e),updateDoubleParameter:i.updateDoubleParameter,updateStringParameter:i.updateStringParameter,updateBooleanParameter:i.updateBooleanParameter,update:i.update};this._isLightingLayer&&(t.pixiFilter.blendMode=n.BLEND_MODES.ADD),this._pixiContainer.filters=(this._pixiContainer.filters||[]).concat(t.pixiFilter),this._filters[e.name]=t}removeEffect(e){const i=this._filters[e];!i||(this._pixiContainer.filters=(this._pixiContainer.filters||[]).filter(function(t){return t!==i.pixiFilter}),delete this._filters[e])}addRendererObject(e,i){e.zOrder=i;for(let t=0,r=this._pixiContainer.children.length;t<r;++t)if(this._pixiContainer.children[t].zOrder>=i){this._pixiContainer.addChildAt(e,t);return}this._pixiContainer.addChild(e)}changeRendererObjectZOrder(e,i){this._pixiContainer.removeChild(e),this.addRendererObject(e,i)}removeRendererObject(e){this._pixiContainer.removeChild(e)}setEffectDoubleParameter(e,i,t){const r=this._filters[e];!r||r.updateDoubleParameter(r.pixiFilter,i,t)}setEffectStringParameter(e,i,t){const r=this._filters[e];!r||r.updateStringParameter(r.pixiFilter,i,t)}setEffectBooleanParameter(e,i,t){const r=this._filters[e];!r||r.updateBooleanParameter(r.pixiFilter,i,t)}hasEffect(e){return!!this._filters[e]}enableEffect(e,i){const t=this._filters[e];!t||s.PixiFiltersTools.enableEffect(t,i)}isEffectEnabled(e){const i=this._filters[e];return i?s.PixiFiltersTools.isEffectEnabled(i):!1}updateClearColor(){this._clearColor=this._layer.getClearColor(),this._updateRenderTexture()}_updateRenderTexture(){if(!this._pixiRenderer||this._pixiRenderer.type!==n.RENDERER_TYPE.WEBGL)return;if(!this._renderTexture){this._oldWidth=this._pixiRenderer.screen.width,this._oldHeight=this._pixiRenderer.screen.height;const t=this._oldWidth,r=this._oldHeight,o=this._pixiRenderer.resolution;this._renderTexture=n.RenderTexture.create({width:t,height:r,resolution:o}),this._renderTexture.baseTexture.scaleMode=n.SCALE_MODES.LINEAR}(this._oldWidth!==this._pixiRenderer.screen.width||this._oldHeight!==this._pixiRenderer.screen.height)&&(this._renderTexture.resize(this._pixiRenderer.screen.width,this._pixiRenderer.screen.height),this._oldWidth=this._pixiRenderer.screen.width,this._oldHeight=this._pixiRenderer.screen.height);const e=this._pixiRenderer.renderTexture.current,i=this._pixiRenderer.renderTexture.sourceFrame;this._pixiRenderer.renderTexture.bind(this._renderTexture),this._pixiRenderer.renderTexture.clear(this._clearColor),this._pixiRenderer.render(this._pixiContainer,this._renderTexture,!1),this._pixiRenderer.renderTexture.bind(e,i,void 0)}_replaceContainerWithSprite(){if(!this._pixiRenderer||this._pixiRenderer.type!==n.RENDERER_TYPE.WEBGL||(this._updateRenderTexture(),!this._renderTexture))return;this._lightingSprite=new n.Sprite(this._renderTexture),this._lightingSprite.blendMode=n.BLEND_MODES.MULTIPLY;const e=this._runtimeSceneRenderer.getPIXIContainer(),i=e.getChildIndex(this._pixiContainer);e.addChildAt(this._lightingSprite,i),e.removeChild(this._pixiContainer)}}s.LayerPixiRenderer=l,s.LayerRenderer=s.LayerPixiRenderer})(gdjs||(gdjs={}));
//# sourceMappingURL=layer-pixi-renderer.js.map
