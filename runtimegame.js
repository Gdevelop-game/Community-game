var gdjs;(function(n){class g{constructor(e,t){this._notifyScenesForGameResolutionResize=!1;this._paused=!1;this._sessionMetricsInitialized=!1;this._disableMetrics=!1;this._options=t||{},this._variables=new n.VariablesContainer(e.variables),this._data=e,this._imageManager=new n.ImageManager(this._data.resources.resources),this._soundManager=new n.SoundManager(this._data.resources.resources),this._fontManager=new n.FontManager(this._data.resources.resources),this._jsonManager=new n.JsonManager(this._data.resources.resources),this._bitmapFontManager=new n.BitmapFontManager(this._data.resources.resources,this._imageManager),this._maxFPS=this._data?this._data.properties.maxFPS:60,this._minFPS=this._data?this._data.properties.minFPS:15,this._gameResolutionWidth=this._data.properties.windowWidth,this._gameResolutionHeight=this._data.properties.windowHeight,this._originalWidth=this._gameResolutionWidth,this._originalHeight=this._gameResolutionHeight,this._resizeMode=this._data.properties.sizeOnStartupMode,this._adaptGameResolutionAtRuntime=this._data.properties.adaptGameResolutionAtRuntime,this._scaleMode=e.properties.scaleMode||"linear",this._renderer=new n.RuntimeGameRenderer(this,this._options.forceFullscreen||!1),this._sceneStack=new n.SceneStack(this),this._inputManager=new n.InputManager,this._injectExternalLayout=this._options.injectExternalLayout||"",this._debuggerClient=n.DebuggerClient?new n.DebuggerClient(this):null,this._isPreview=this._options.isPreview||!1}setProjectData(e){this._data=e,this._imageManager.setResources(this._data.resources.resources),this._soundManager.setResources(this._data.resources.resources),this._fontManager.setResources(this._data.resources.resources),this._jsonManager.setResources(this._data.resources.resources),this._bitmapFontManager.setResources(this._data.resources.resources)}getAdditionalOptions(){return this._options}getRenderer(){return this._renderer}getVariables(){return this._variables}getSoundManager(){return this._soundManager}getImageManager(){return this._imageManager}getFontManager(){return this._fontManager}getBitmapFontManager(){return this._bitmapFontManager}getInputManager(){return this._inputManager}getJsonManager(){return this._jsonManager}getGameData(){return this._data}getSceneData(e){let t=null;for(let i=0,a=this._data.layouts.length;i<a;++i){const s=this._data.layouts[i];if(e===void 0||s.name===e){t=s;break}}return t===null&&console.warn('The game has no scene called "'+e+'"'),t}hasScene(e){let t=!1;for(let i=0,a=this._data.layouts.length;i<a;++i){const s=this._data.layouts[i];if(e===void 0||s.name==e){t=!0;break}}return t}getExternalLayoutData(e){let t=null;for(let i=0,a=this._data.externalLayouts.length;i<a;++i){const s=this._data.externalLayouts[i];if(s.name===e){t=s;break}}return t}getInitialObjectsData(){return this._data.objects||[]}getOriginalWidth(){return this._originalWidth}getOriginalHeight(){return this._originalHeight}getGameResolutionWidth(){return this._gameResolutionWidth}getGameResolutionHeight(){return this._gameResolutionHeight}setGameResolutionSize(e,t){if(this._gameResolutionWidth=e,this._gameResolutionHeight=t,this._adaptGameResolutionAtRuntime&&n.RuntimeGameRenderer&&n.RuntimeGameRenderer.getWindowInnerWidth&&n.RuntimeGameRenderer.getWindowInnerHeight){const i=n.RuntimeGameRenderer.getWindowInnerWidth(),a=n.RuntimeGameRenderer.getWindowInnerHeight();let s=this._gameResolutionWidth,r=this._gameResolutionHeight;this._resizeMode==="adaptWidth"?this._gameResolutionWidth=this._gameResolutionHeight*i/a:this._resizeMode==="adaptHeight"&&(this._gameResolutionHeight=this._gameResolutionWidth*a/i)}this._renderer.updateRendererSize(),this._notifyScenesForGameResolutionResize=!0}setGameResolutionResizeMode(e){this._resizeMode=e,this._forceGameResolutionUpdate()}getGameResolutionResizeMode(){return this._resizeMode}setAdaptGameResolutionAtRuntime(e){this._adaptGameResolutionAtRuntime=e,this._forceGameResolutionUpdate()}getAdaptGameResolutionAtRuntime(){return this._adaptGameResolutionAtRuntime}getMinimalFramerate(){return this._minFPS}getScaleMode(){return this._scaleMode}pause(e){this._paused=e}loadAllAssets(e,t){const i=new n.LoadingScreenRenderer(this.getRenderer(),this._data.properties.loadingScreen),a=this._data.resources.resources.length,s=this;this._imageManager.loadTextures(function(r,o){const u=Math.floor(r/a*100);i.render(u),t&&t(u)},function(r){s._soundManager.preloadAudio(function(o,u){const d=Math.floor((r+o)/a*100);i.render(d),t&&t(d)},function(o){s._fontManager.loadFonts(function(u,d){const l=Math.floor((r+o+u)/a*100);i.render(l),t&&t(l)},function(u){s._jsonManager.preloadJsons(function(d,l){const h=Math.floor((r+o+u+d)/a*100);i.render(h),t&&t(h)},function(d){s._bitmapFontManager.loadBitmapFontData(l=>{var h=Math.floor((r+o+u+d+l)/a*100);i.render(h),t&&t(h)}).then(()=>{i.unload(),e()})})})})})}startGameLoop(){if(!this.hasScene()){console.log("The game has no scene.");return}this._forceGameResolutionUpdate();const e=this._data.firstLayout;this._sceneStack.push(this.hasScene(e)?e:this.getSceneData().name,this._injectExternalLayout);const t=this;let i=0;this._renderer.startGameLoop(function(a){if(t._paused||(i+=a,t._maxFPS>0&&1e3/i>t._maxFPS+7))return!0;const s=i;return i=0,t._notifyScenesForGameResolutionResize&&(t._sceneStack.onGameResolutionResized(),t._notifyScenesForGameResolutionResize=!1),t._sceneStack.step(s)?(t.getInputManager().onFrameEnded(),!0):!1}),setTimeout(()=>{this._setupSessionMetrics()},1e4)}enableMetrics(e){this._disableMetrics=!e,e&&this._setupSessionMetrics()}_setupSessionMetrics(){if(this._sessionMetricsInitialized||this._disableMetrics||this.isPreview()||typeof fetch=="undefined"||!this._data.properties.projectUuid)return;const e="https://api.gdevelop-app.com/analytics",t=this._makePlayerUuid();let i=null,a=Date.now();fetch(e+"/session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gameId:this._data.properties.projectUuid,playerId:t,game:{name:this._data.properties.name||"",packageName:this._data.properties.packageName||"",version:this._data.properties.version||"",location:window.location.href},platform:{isCordova:!!window.cordova,devicePlatform:typeof device!="undefined"&&device.platform||"",navigatorPlatform:typeof navigator!="undefined"?navigator.platform:"",hasTouch:typeof navigator!="undefined"?!!navigator.maxTouchPoints&&navigator.maxTouchPoints>2:!1}})}).then(r=>r.text()).then(r=>{i=r}).catch(()=>{});const s=()=>{!i||Date.now()-a<3*1e3||(a=Date.now(),navigator.sendBeacon(e+"/session-hit",JSON.stringify({gameId:this._data.properties.projectUuid,playerId:t,sessionId:i})))};if(typeof navigator!="undefined"&&typeof document!="undefined"){document.addEventListener("visibilitychange",()=>{s()}),window.addEventListener("pagehide",()=>{s()},!1);const r=typeof safari=="object"&&safari.pushNotification,o=/electron/i.test(navigator.userAgent);(r||o)&&window.addEventListener("beforeunload",()=>{s()})}this._sessionMetricsInitialized=!0}_makePlayerUuid(){try{const e="GDJS-internal-player-uuid",t=localStorage.getItem(e);if(t)return t;const i=n.makeUuid();return localStorage.setItem(e,i),i}catch(e){return n.makeUuid()}}onWindowInnerSizeChanged(){this._forceGameResolutionUpdate()}_forceGameResolutionUpdate(){this.setGameResolutionSize(this._gameResolutionWidth,this._gameResolutionHeight)}startCurrentSceneProfiler(e){const t=this._sceneStack.getCurrentScene();return t?(t.startProfiler(e),!0):!1}stopCurrentSceneProfiler(){const e=this._sceneStack.getCurrentScene();!e||e.stopProfiler()}wasFirstSceneLoaded(){return this._sceneStack.wasFirstSceneLoaded()}getSceneStack(){return this._sceneStack}isPreview(){return this._isPreview}getExtensionProperty(e,t){for(let i of this._data.properties.extensionProperties)if(i.extension===e&&i.property===t)return i.value;return null}}n.RuntimeGame=g})(gdjs||(gdjs={}));
//# sourceMappingURL=runtimegame.js.map
